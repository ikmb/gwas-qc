BootStrap: localimage
From: baseimage.img
#From: ubuntu:17.04
#OSVersion: zesty
#MirrorURL: ftp://ftp.rz.uni-kiel.de/pub2/linux/ubuntu/

%files
EIG4.2.tar.xz /opt/

%post -c /bin/bash

echo "Installing basic build system"
#sed -i 's/$/ universe/' /etc/apt/sources.list
apt -y update
apt -y dist-upgrade
apt -y install build-essential locales wget unzip r-base git tclsh bash psmisc curl ghostscript gnuplot gawk moreutils

echo "Setting bash as default shell (instead of dash, thanks Canonical Inc)"
rm /bin/sh
ln -s /bin/bash /bin/sh

locale-gen en_US en_US.UTF-8 de_DE.UTF-8 de_DE

echo "Installing Plink 1.07"
if [ ! -e /opt/plink-1.07 ]; then
   cd /opt
   wget -nc 'http://zzz.bwh.harvard.edu/plink/dist/plink-1.07-x86_64.zip'
   unzip -o plink-1.07-x86_64.zip
   mv plink-1.07-x86_64 plink-1.07
   rm -f plink-1.07-x86_64.zip
else
   echo "  Already there."
fi

echo "Installing Plink 1.9"
if [ ! -e /opt/plink-1.9 ]; then
   cd /opt
   mkdir -p plink-1.9
   cd plink-1.9
   wget -nc $(curl -s https://www.cog-genomics.org/plink2 | grep plink_linux_x86_64.zip | perl -e '$_=<>;s|.*/static/bin/plink(.*)/plink_linux_x86_64.zip.*|https://www.cog-genomics.org/static/bin/plink$1/plink_linux_x86_64.zip|;print')
   unzip -o plink_linux_x86_64.zip
   rm -f plink_linux_x86_64.zip
else
   echo "  Already there."
fi

echo "Installing EIGENSTRAT 6.1.4"
if [ ! -e /opt/eigensoft-6.1.4 ]; then
   cd /opt
   wget -nc https://data.broadinstitute.org/alkesgroup/EIGENSOFT/EIG-6.1.4.tar.gz
   tar xvaf EIG-6.1.4.tar.gz
   mv EIG-6.1.4 eigensoft-6.1.4
   rm -f EIG-6.1.4.tar.gz
else
   echo "  Already there."
fi

echo "Installing EIGENSTRAT 4.2"
if [ ! -e /opt/eigensoft-4.2 ]; then
   cd /opt
   # archive is copied from host system in %files section
   tar xvaf EIG4.2.tar.xz
   mv EIG4.2 eigensoft-4.2
   rm -f EIG4.2.tar.xz
else
   echo "  Already there."
fi

echo "Installing FlashPCA2"
if [ ! -e /opt/flashpca2 ]; then
  cd /opt
  mkdir -p flashpca2
  cd flashpca2
  wget -nc https://github.com/gabraham/flashpca/releases/download/v2.0/flashpca_x86-64.gz
  gunzip flashpca_x86-64.gz
  chmod a+x flashpca_x86-64 
  ln -s flashpca_x86-64 flashpca2
  rm -f flashpca_x86-64.gz
else
  echo "  Already there."
fi

# Make bind mount points
mkdir -p /scratch
chmod 777 /scratch
mkdir -p /work_zfs/sukmb388
chmod 777 /work_zfs/sukmb388
mkdir -p /home/sukmb388
chmod 777 /home/sukmb388

echo "Installing R packages"
   touch /tmp/packages.r
   echo "if('Rserve' %in% rownames(installed.packages()) == FALSE) {install.packages('Rserve', repo='http://cran.uni-muenster.de/')}" >/tmp/packages.r
   echo "if('hwde' %in% rownames(installed.packages()) == FALSE) {install.packages('hwde', repo='http://cran.uni-muenster.de/')}" >>/tmp/packages.r
   echo "if('SNPRelate' %in% rownames(installed.packages()) == FALSE) {source('https://bioconductor.org/biocLite.R'); biocLite('SNPRelate')}" >>/tmp/packages.r
   echo "if('sm' %in% rownames(installed.packages()) == FALSE) {install.packages('sm', repo='http://cran.uni-muenster.de/')}" >>/tmp/packages.r
   echo "if('plotrix' %in% rownames(installed.packages()) == FALSE) {install.packages('plotrix', repo='http://cran.uni-muenster.de/')}" >>/tmp/packages.r
   echo "writeLines('  All done')" >>/tmp/packages.r
   Rscript /tmp/packages.r

echo "Installing modules"
if [ ! -e /opt/modules-modules-tcl ]; then
   cd /opt
   git clone --branch v1.832 --depth 1 https://git.code.sf.net/p/modules/modules-tcl modules-modules-tcl || true
   cd modules-modules-tcl
   echo "#!/bin/bash" >/tmp/modules-setup.bash
   echo "./configure && make -j && make install" >>/tmp/modules-setup.bash
   chmod a+x /tmp/modules-setup.bash
   /tmp/modules-setup.bash
else
   echo "  Already there."
fi

echo "Updating custom modules"
if [ ! -e /opt/modules ]; then
   cd /opt
   git clone --depth 1 http://git.ikmb.uni-kiel.de/j.kaessens/singularity-modules.git modules || true
   echo "module use --append /opt/modules" >>/usr/local/modules-tcl/init/modulerc
else
   cd /opt/modules
   git pull --rebase
fi

echo "Cleanup..."
   apt-get -y --purge autoremove
   apt-get -y clean

%environment
export MODULEPATH=/opt/modules
source /usr/local/modules-tcl/init/bash

