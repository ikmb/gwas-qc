#!/usr/bin/env perl

use 5.024;

# Append "." to include path
BEGIN {push @INC, '.'}

use Time::HiRes qw(gettimeofday);
use Report::Generator;
use Report::Rs;

use strict;
use warnings;

my %processors = (
    'Rs' => {
        'plink_flip' => \&Report::Rs::plink_flip,
        'plink_exclude' => \&Report::Rs::plink_exclude
    }
);

sub expand_path {
    my $base = shift;
    my $hash = shift;

    if ($hash =~ m|(..)/(.*)|) {
        my $hash_base = $1;
        my $hash_remainder = $2;
        opendir(my $dh, "$base/$hash_base/") or die($!);
        my @results = grep { /^$hash_remainder.*/ } readdir($dh);
        closedir $dh;

        if (@results > 0) {
            return $base . "/" . $hash_base . "/" . $results[0];
        } else {
            return "/dev/null";
        }
    }
}

my $arg_pipeline = shift @ARGV;
my $arg_workdir = shift @ARGV;

my $report = Report::Generator->new();

# Parse trace
open (my $trace, '<', 'trace.txt') or die($!);
open (my $tex, '>', 'Report/report.tex') or die($!);

<$trace>;
while(<$trace>) {
    chomp;
    my ($process, $procname, $tag, $workdir) = split /;/;
    if (exists $processors{$arg_pipeline}{$process}) {
        my $expanded = expand_path($arg_workdir, $workdir);

        $report->append($processors{$arg_pipeline}{$process}->($expanded, $tag));
    }
}
close $trace;

print $tex $report->to_string();
close $tex;


